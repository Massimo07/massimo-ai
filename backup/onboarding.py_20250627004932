from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.ext import (
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
)
import logging

# --- Lingue e Frasi di benvenuto ---
LANGUAGES = [
    ('it', 'ğŸ‡®ğŸ‡¹ Italiano', 'Italiano selezionato! Benvenuto!'),
    ('en', 'ğŸ‡¬ğŸ‡§ English', 'English selected! Welcome!'),
    ('es', 'ğŸ‡ªğŸ‡¸ EspaÃ±ol', 'Â¡EspaÃ±ol seleccionado! Â¡Bienvenido!'),
    ('fr', 'ğŸ‡«ğŸ‡· FranÃ§ais', 'FranÃ§ais sÃ©lectionnÃ©! Bienvenue!'),
    ('de', 'ğŸ‡©ğŸ‡ª Deutsch', 'Deutsch ausgewÃ¤hlt! Willkommen!'),
    ('ro', 'ğŸ‡·ğŸ‡´ RomÃ¢nÄƒ', 'RomÃ¢nÄƒ selectatÄƒ! Bun venit!'),
    ('pt', 'ğŸ‡µğŸ‡¹ PortuguÃªs', 'PortuguÃªs selecionado! Bem-vindo!'),
    ('nl', 'ğŸ‡³ğŸ‡± Nederlands', 'Nederlands geselecteerd! Welkom!'),
    ('el', 'ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬', 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬ ÎµÏ€Î¹Î»Î­Ï‡Î¸Î·ÎºÎ±Î½! ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸Î±Ï„Îµ!'),
    ('ru', 'ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹', 'Ğ ÑƒÑÑĞºĞ¸Ğ¹ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½! Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ!'),
    ('ar', 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©! Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹!'),
    ('zh', 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡', 'å·²é€‰æ‹©ä¸­æ–‡ï¼æ¬¢è¿ï¼')
]

MAIN_MENU = [
    ('Cosa Ã¨ il network marketing', 'menu_network'),
    ('Chi Ã¨ Live On Plus', 'menu_azienda'),
    ('Il nostro piano marketing', 'menu_marketing'),
    ('Differenze: venditore, consumatore, networker', 'menu_diff'),
    ('PerchÃ© scegliere Live On Plus', 'menu_perche_lop'),
    ('PerchÃ© scegliere il Magic Team', 'menu_perche_magic'),
    ('FAQ', 'menu_faq'),
    ('Motivazione del Giorno', 'menu_motivazione'),
    ('Prodotti & Cataloghi', 'menu_prodotti'),
    ('Registrati', 'menu_registrati'),
    ('Sei indeciso? Dimmi perchÃ©â€¦', 'menu_obiezioni'),
    ('Momento no? Ti aiuto', 'menu_aiuto'),
    ('Scarica il PDF aziendale', 'menu_pdf'),
    ('Contatta il tuo sponsor', 'menu_sponsor'),
    ('Testimonianze', 'menu_testimonianze'),
    # ...altre voci...
]

def build_language_keyboard():
    keyboard = []
    row = []
    for i, (code, name, _) in enumerate(LANGUAGES, 1):
        row.append(InlineKeyboardButton(name, callback_data=f"lang_{code}"))
        if i % 2 == 0:
            keyboard.append(row)
            row = []
    if row:
        keyboard.append(row)
    return InlineKeyboardMarkup(keyboard)

def build_main_menu_keyboard():
    keyboard = []
    row = []
    for i, (label, callback) in enumerate(MAIN_MENU, 1):
        row.append(InlineKeyboardButton(label, callback_data=callback))
        if i % 2 == 0:
            keyboard.append(row)
            row = []
    if row:
        keyboard.append(row)
    return InlineKeyboardMarkup(keyboard)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ğŸŒ Scegli la tua lingua / Choose your language:",
        reply_markup=build_language_keyboard()
    )

async def language_selected(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    code = query.data.split("_")[1]
    for c, _, welcome in LANGUAGES:
        if c == code:
            await query.edit_message_text(
                f"{welcome}\n\nğŸš€ Ora puoi continuare con Massimo AI!",
            )
            # Mostra il menu principale subito dopo la selezione lingua
            await context.bot.send_message(
                chat_id=query.message.chat.id,
                text="ğŸ‘‡ Scegli una delle opzioni qui sotto per iniziare:",
                reply_markup=build_main_menu_keyboard()
            )
            return

onboarding_handlers = [
    CommandHandler("start", start),
    CallbackQueryHandler(language_selected, pattern="^lang_"),
]
